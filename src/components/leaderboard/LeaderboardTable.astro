---
// src/components/leaderboard/LeaderboardTable.astro
---

<section class='max-w-2xl px-4 mx-auto mt-12'>
	<h2 class='mb-4 text-4xl font-bold text-center'>Full Leaderboard</h2>
	<div class='overflow-x-auto font-semibold text-white'>
		<table class='w-full bg-gray-900 border-collapse rounded-md shadow-lg'>
			<thead class='bg-gray-700'>
				<tr>
					<th class='p-3 text-sm font-semibold tracking-wider text-left'>#</th>
					<th class='p-3 text-sm font-semibold tracking-wider text-left'>Team</th>
					<th class='p-3 text-sm font-semibold tracking-wider text-right'>Score</th>
				</tr>
			</thead>
			<tbody id='leaderboard-body' class='text-sm divide-y divide-gray-700'></tbody>
		</table>
	</div>

	<script is:inline type='module'>
		const body = document.getElementById('leaderboard-body')

		const CACHE_KEY = 'teams-cache-v1'
		const CACHE_TTL_MS = 60 * 1000 // 1 minute

		const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null')
		const isFresh = cached && Date.now() - cached.timestamp < CACHE_TTL_MS

		const teams = isFresh
			? cached.data
			: await fetch(
					'https://script.google.com/macros/s/AKfycbx5dfoJhQTjR2QdsraYKbt2nkAqsy9702douB08uyliGH8YaVHCOWL1q7eKLXkxf8efkA/exec'
				)
					.then((res) => res.json())
					.then((data) => {
						localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }))
						return data
					})

		const sorted = [...teams].sort((a, b) => b.score - a.score)
		const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰']

		const rows = sorted
			.map((team, index) => {
				const rank = index + 1
				const medal = medals[index] || rank
				return `
					<tr class="hover:bg-gray-800">
						<td class="p-3">${medal}</td>
						<td class="p-3 font-medium">${team.team}</td>
						<td class="p-3 font-semibold text-right">${team.score}</td>
					</tr>
				`
			})
			.join('')

		body.innerHTML = rows
	</script>
</section>

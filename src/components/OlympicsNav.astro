---
// src/components/OlympicsNav.astro

const links = [
	{ href: '#spotify-player', label: 'Playlist', icon: '🎶' },
	{ href: '#klassement', label: 'Klassement', icon: '📊' },
	{ href: '#teams', label: 'Teams', icon: '👥' },
	{ href: '#spellen', label: 'Spellen', icon: '🎮' },
	{ href: '#locatie', label: 'Locatie', icon: '📍' },
	{ href: 'https://skatecafe.weticket.io/nachtwinkel', label: 'AftrParty', icon: '🎉' }
]
---

<nav class='absolute inset-x-0 top-0 z-40 mx-auto sm:max-w-xl md:max-w-2xl lg:max-w-4xl'>
	<div
		class='grid grid-cols-3 gap-3 rounded bg-gray-900/80 px-4 py-3 shadow-lg ring-1 ring-white/10 backdrop-blur-md'
	>
		{
			links.map(({ href, label, icon }, i) => {
				const isLast = i === links.length - 1
				const isOdd = links.length % 3 !== 0
				const forceFullWidth = isOdd && isLast
				return (
					<a
						href={href}
						target={href.startsWith('http') ? '_blank' : '_self'}
						rel={href.startsWith('http') ? 'noopener noreferrer' : undefined}
						class={`inline-flex items-center justify-center gap-1 rounded-lg bg-gray-800 px-4 py-2 text-center text-sm font-medium text-white transition hover:bg-gray-700 ${
							forceFullWidth ? 'col-span-3 justify-center' : ''
						}`}
					>
						<span>{icon}</span>
						<span>{label}</span>
					</a>
				)
			})
		}
	</div>

	<!-- Admin Toggle -->
	<div class='mt-2 px-4 text-right'>
		<button id='admin-toggle' class='text-xs text-gray-400 underline hover:text-white'>
			Admin
		</button>
	</div>

	<!-- Collapsible Admin Panel -->
	<div
		id='admin-panel'
		class='mt-1 hidden flex-col gap-2 rounded bg-gray-800 px-4 py-3 text-sm shadow'
	>
		<div class='mx-auto flex items-center gap-2'>
			<label for='fetch-name' class='text-white'>Naam:</label>
			<input
				id='fetch-name'
				type='text'
				class='w-full rounded px-2 py-1 text-black'
				autocomplete='off'
				aria-label='Naam'
			/>
		</div>

		<!-- Clean horizontal admin options -->
		<div
			id='fetch-toggle-wrapper'
			class='mt-2 flex hidden w-full flex-row flex-wrap items-center gap-x-4 gap-y-2 border-t border-white/10 pt-2 text-white'
		>
			<label class='flex items-center gap-2'>
				<input type='checkbox' id='toggle-fetch' />
				Live updates aan
			</label>

			<label class='flex items-center gap-2'>
				TTL:
				<input
					id='ttl-input'
					type='number'
					min='10'
					step='10'
					class='w-20 rounded px-1 py-0.5 text-black'
				/>
				<span class='text-xs text-gray-300'>sec</span>
			</label>

			<button
				id='manual-fetch'
				class='rounded bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-500'
			>
				Fetch Now
			</button>
		</div>
	</div>

	<script is:inline type='module'>
		const allowedName = 'Stijn'
		const adminToggle = document.getElementById('admin-toggle')
		const adminPanel = document.getElementById('admin-panel')
		const nameInput = document.getElementById('fetch-name')
		const toggleWrapper = document.getElementById('fetch-toggle-wrapper')
		const toggleCheckbox = document.getElementById('toggle-fetch')
		const ttlInput = document.getElementById('ttl-input')
		const manualFetchBtn = document.getElementById('manual-fetch')

		// Show/hide admin panel
		adminToggle.addEventListener('click', () => {
			adminPanel.classList.toggle('hidden')
		})

		// Init toggle state
		if (localStorage.getItem('enable-fetch') === 'true') {
			toggleCheckbox.checked = true
		}

		// Init TTL
		const savedTTL = localStorage.getItem('fetch-ttl')
		if (savedTTL) {
			ttlInput.value = parseInt(savedTTL) / 1000
		}

		nameInput.addEventListener('input', () => {
			if (nameInput.value.trim().toLowerCase() === allowedName.toLowerCase()) {
				toggleWrapper.classList.remove('hidden')
			} else {
				toggleWrapper.classList.add('hidden')
				localStorage.removeItem('enable-fetch')
			}
		})

		toggleCheckbox.addEventListener('change', (e) => {
			if (e.target.checked) {
				localStorage.setItem('enable-fetch', 'true')
			} else {
				localStorage.removeItem('enable-fetch')
			}
		})

		ttlInput.addEventListener('change', () => {
			const ttl = parseInt(ttlInput.value || '60') * 1000
			localStorage.setItem('fetch-ttl', ttl.toString())
		})

		manualFetchBtn.addEventListener('click', async () => {
			const url =
				'https://script.google.com/macros/s/AKfycbyNoXrb1X89KTKgPwkIh_nYOGHDZnd_EZIrmwnTT4rbQD10gcX8Wvw2PJhQWCQLzneAVQ/exec'
			const res = await fetch(url)
			const data = await res.json()
			localStorage.setItem('teams-cache-v1', JSON.stringify({ data, timestamp: Date.now() }))
			alert('Data manually fetched and cached!')
			location.reload()
		})
	</script>
</nav>
